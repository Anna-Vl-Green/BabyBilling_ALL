# Описание структуры баз данных

Каждый из микросервисов имеет собственную базу данных согласно своей зоне ответственности.
Таким образом, проект содержит 4 базы данных:
* CDRg;
* BRT;
* HRS;
* CRM.

## CDRg
База данных сервиса “Генератор CDR”, содержащая информацию об абонентах и их звонках, генерируемых самим сервисом.
Таблицы и их описание расположены в раскрывающемся элементе:

### subscribers
Хранит номера телефонов абонентов. Выбранный тип данных для MSISDN обусловлен тем фактом, что звонки могут совершаться
не только с российских номеров, при этом максимальная длина телефонного номера составляет 15 цифр.

| Атрибут  | Тип данных     | Ограничения         | Описание                |
|----------|----------------|---------------------|-------------------------|
| id       | integer        | PRIMARY KEY         | Идентификатор абонента  |
| msisdn   | varchar(15)    | NOT NULL, UNIQUE    | Номер телефона абонента |

### calls
Хранит информацию о звонках абонентов. Тип данных bigint для первичного ключа обусловлен бизнес-логикой процесса
(звонков может быть много - гораздо больше, чем абонентов). 

| Атрибут                 | Тип данных | Ограничения                              | Описание                                           |
|-------------------------|------------|------------------------------------------|----------------------------------------------------|
| id                      | bigint     | PRIMARY KEY                              | Идентификатор вызова                               |
| subscriber_id           | integer    | FOREIGN KEY, NOT NULL                    | Идентификатор абонента                             |
| contacted_subscriber_id | integer    | FOREIGN KEY, NOT NULL                    | Идентификатор абонента, с которым совершался вызов |
| start_time              | timestamp  | NOT NULL                                 | Дата и время начала вызова                         |
| end_time                | timestamp  | NOT NULL, CHECK (end_time >= start_time) | Дата и время окончания вызова                      |
| type                    | integer    | NOT NULL                                 | Тип вызова                                         |

## BRT
Содержит информацию об абонентах оператора “Ромашка”. 

### subscribers
* Для атрибута msisdn здесь был выбран тип данных char(11) исходя из предположения, что оператор обслуживает российские номера, содержащие 11 цифр.
* Помимо атрибутов balance и balance_minutes, необходимых для выполнения задания, были добавлены также атрибуты balance_sms и balance_kilobytes, чтобы обеспечить расширяемость системы.  

| Атрибут           | Тип данных   | Ограничения                    | Описание                       |
|-------------------|--------------|--------------------------------|--------------------------------|
| id                | integer      | PRIMARY KEY                    | Идентификатор абонента         |
| msisdn            | char(11)     | NOT NULL, UNIQUE               | Номер телефона абонента        |
| balance           | numeric(9,1) | NOT NULL                       | Текущий баланс абонента (у.е.) |
| balance_minutes   | smallint     | CHECK (balance_minutes >= 0)   | Остаток минут на счёте         |
| balance_sms       | smallint     | CHECK (balance_sms >= 0)       | Остаток СМС на счёте           |
| balance_kilobytes | integer      | CHECK (balance_kilobytes >= 0) | Остаток килобайт на счёте      |
| tariff_id         | smallint     | NOT NULL                       | Идентификатор тарифа           |

## HRS
Содержит информацию о тарифах оператора “Ромашка”.

### tariffs
Поскольку необходимо было обеспечить возможность в будущем добавлять тарифы с новыми условиями, не прибегая к модификации базы данных, при проектировании выбор стоял между типом данных jsonb, поддерживаемым PostgreSQL, и подходом EAV (entity-attribute-value). Решено было остановиться на первом варианте, поскольку:
* данный формат занимает меньше места;
* упрощается чтение схемы;
* как правило, запросы выполняются быстрее, чем с EAV (хоть и не всегда).

| Атрибут | Тип данных  | Ограничения      | Описание                                                                                                         |
|---------|-------------|------------------|------------------------------------------------------------------------------------------------------------------|
| id      | smallint    | PRIMARY KEY      | Идентификатор тарифа                                                                                             |
| name    | varchar(50) | NOT NULL, UNIQUE | Название тарифа                                                                                                  |
| details | jsonb       | NOT NULL         | JSON, содержащий детальную информацию о тарифе (количество предоставляемых минут, стоимость обслуживания и т.п.) |

Содержание таблицы:

| id | name       | details                                                                                                                                                                          |
|----|------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 11 | Классика   | ```[{"type": "incomingCost", "value": 0}, {"type": "incomingCostForSubs", "value": 0}, {"type": "outgoingCost", "value": 2.5}, {"type": "outgoingCostForSubs", "value": 1.5}]``` |
| 12 | Помесячный | ```[{"type": "minutesAmount", "value": 50}, {"type": "monthlyFee", "value": 100}]```                                                                                             |

## CRM
База данных микросервиса CRM, в которой содержатся данные для аутентификации пользователя с ролью “Менеджер”. По-хорошему эта информация должна храниться в отдельном микросервисе для аутентификации и авторизации, но было принято решение оставить эти данные здесь во избежание усложнения системы в целом.

Ещё одно замечание: в БД не хранится информация об абонентах, поскольку им предоставляется доступ к сервису только по номеру телефона. Таким образом, для предоставления прав абоненту необходимо убедиться, что его номер присутствует в BRT. 

### managers

| Атрибут  | Тип данных  | Ограничения      | Описание                                         |
|----------|-------------|------------------|--------------------------------------------------|
| id       | smallint    | PRIMARY KEY      | Идентификатор менеджера                          |
| username | varchar(50) | NOT NULL, UNIQUE | Логин менеджера                                  |
| password | varchar(64) | NOT NULL         | Пароль менеджера (хранится в зашифрованном виде) |
